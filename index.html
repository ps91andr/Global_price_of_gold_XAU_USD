<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¤Ø´Ø± Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ (ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ)</title>
    <style>
        /* ===== Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ===== */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #2c3e50, #34495e);
            color: #ecf0f1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
        .container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: linear-gradient(to bottom, #4a6582, #3a5572);
            border-radius: 15px;
            border: 1px solid #5a7592;
            padding: 10px 20px 20px 20px;
        }

        .title-tag {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            font-weight: bold;
            padding: 10px 25px;
            border-radius: 15px;
            font-size: 26px;
            border: 2px solid #5dade2;
            text-align: center;
            margin: 0 auto 15px auto;
            display: table;
        }

        /* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ===== */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        #status_label, #market_status_label, #session_status_label {
            font-weight: bold;
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            transition: background 0.3s ease;
            cursor: help;
        }

        #status_label[status="connected"], #market_status_label[status="open"] {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
        }
        #status_label[status="disconnected"], #market_status_label[status="closed"], #session_status_label[status="closed"] {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }
        #status_label[status="connecting"], #status_label[status="error"] {
            background: linear-gradient(to bottom, #f39c12, #e67e22);
        }
        #session_status_label[status="peak"] { background: linear-gradient(to bottom, #f39c12, #d35400); }
        #session_status_label[status="active"] { background: linear-gradient(to bottom, #3498db, #2980b9); }
        #session_status_label[status="warmup"] { background: linear-gradient(to bottom, #1abc9c, #16a085); }
        #session_status_label[status="calm"] { background: linear-gradient(to bottom, #95a5a6, #7f8c8d); }

        #last_update_label {
            font-size: 16px;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 5px 10px;
            border-radius: 10px;
        }

        #global_price_frame {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border: 4px solid #e74c3c;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        #global_price_frame.price-up {
            background: linear-gradient(to bottom, #d4efdf, #f8f9fa);
            border-color: #2ecc71;
        }

        #global_price_frame.price-down {
            background: linear-gradient(to bottom, #fdedec, #f8f9fa);
            border-color: #e74c3c;
        }

        #global_price_title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .price-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        #global_price_value {
            font-size: 76px;
            font-weight: bold;
            color: #34495e;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        #up_arrow, #down_arrow {
            font-size: 40px; 
            font-weight: bold; 
            display: none;
        }
        #up_arrow { color: #2ecc71; }
        #down_arrow { color: #e74c3c; }

        /* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ===== */
        .prices-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .price-card {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 15px;
            transition: border-color 0.3s ease;
        }

        .price-card:hover {
            border-color: #3498db;
        }

        .price-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 12px;
        }

        .karat-label {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .priceLabel {
            font-size: 35px;
            font-weight: bold;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .priceLabel.copied {
            border-color: #2ecc71;
        }

        [data-karat="24"] { color: #27ae60; }
        [data-karat="22"] { color: #d35400; }
        [data-karat="21"] { color: #f39c12; }
        [data-karat="18"] { color: #8e44ad; }
        [data-karat="14"] { color: #2980b9; }

        /* ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ø§Ø³Ø¨Ø§Øª ===== */
        .settings-card, .calculator-card {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 20px;
            color: #2c3e50;
        }

        .setting-label, .api-label, .calc-label {
            font-weight: bold;
            font-size: 18px;
        }

        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            background: #ffffff;
            color: #2c3e50;
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: #3498db;
            background: #f8f9fa;
            outline: none;
        }

        .separator {
            border-top: 2px solid #dfe6e9;
            margin: 20px 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white; 
            font-weight: bold; 
            border: none; 
            padding: 14px 25px;
            border-radius: 10px; 
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: background 0.3s, border-color 0.3s;
            flex-grow: 1;
        }

        button:hover {
            background: linear-gradient(to bottom, #4eaadd, #3498db);
        }

        button:active {
            background: linear-gradient(to bottom, #2980b9, #1c5a85);
        }
        
        button.reset, button.clear {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
        }
        button.reset:hover, button.clear:hover {
            background: linear-gradient(to bottom, #b3b6b7, #95a5a6);
        }

        #connection_button.connected {
             background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }

        #visibility_button.visible {
            background: linear-gradient(to bottom, #f39c12, #d35400);
        }

        .api-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .api-links a {
            color: #000000;
            text-decoration: underline;
            margin-right: 15px;
        }
        .api-links a:hover {
            color: #5dade2;
        }

        /* ===== Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª ===== */
        .calc-grid-header {
            font-weight: bold;
            font-size: 16px;
            background-color: #95a5a6;
            color: #2c3e50;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .calc-grid-result {
            font-size: 20px;
            font-weight: bold;
            background-color: #ecf0f1;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            text-align: center;
            min-height: 30px; /* To prevent layout shift */
        }

        .calc-karat-label {
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            padding-top: 8px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group .calc-label {
            flex-shrink: 0;
        }
        .input-group input, .input-group select {
            flex-grow: 1;
            min-width: 150px;
        }
        .input-group button {
            flex-shrink: 0;
            padding: 12px 20px;
        }

        /* ===== Custom Tooltip ===== */
        .custom-tooltip {
            position: absolute;
            visibility: hidden; /* Use visibility for smooth transitions */
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #4a6582;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 1000;
            max-width: 550px; /* Increased max-width */
            min-width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            line-height: 1.6;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .custom-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        .custom-tooltip h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 18px;
        }
        .custom-tooltip table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            text-align: center;
            background-color: #4a6582;
            border: 1px solid #5a7592;
        }
        .custom-tooltip th, .custom-tooltip td {
            border: 1px solid #5a7592;
            padding: 6px;
        }
        .custom-tooltip th {
            background-color: #2c3e50;
        }
        .custom-tooltip ul {
            padding-right: 20px;
            margin: 10px 0;
        }
        .custom-tooltip .highlight-green { color: #2ecc71; }
        .custom-tooltip .highlight-red { color: #e74c3c; }
        .custom-tooltip .highlight-orange { color: #f39c12; }
    </style>
</head>
<body>

    <div class="container">
         <!-- ğŸ† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø°Ù‡Ø¨ -->
         <div class="panel">
             <h2 class="title-tag">ğŸ† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø°Ù‡Ø¨ (XAU/USD)</h2>
             <div class="top-bar">
                 <div id="status_label" status="connecting">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
                 <div id="market_status_label" status="">...</div>
                 <div id="session_status_label" status="">...</div>
                 <div style="flex-grow: 1;"></div>
                 <div id="last_update_label">...</div>
             </div>
             <div id="global_price_frame">
                 <div id="global_price_title">Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆÙ†ØµØ© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ</div>
                 <div class="price-container">
                     <div id="global_price_value">$0.00</div>
                     <div id="up_arrow">â–²</div>
                     <div id="down_arrow">â–¼</div>
                 </div>
             </div>
         </div>
 
         <!-- ğŸ’µ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª -->
         <div class="prices-layout">
             <div class="panel">
                 <h3 class="title-tag">ğŸ’µ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 24</div><div class="priceLabel" data-karat="24" id="local_24k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 22</div><div class="priceLabel" data-karat="22" id="local_22k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 21</div><div class="priceLabel" data-karat="21" id="local_21k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 18</div><div class="priceLabel" data-karat="18" id="local_18k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 14</div><div class="priceLabel" data-karat="14" id="local_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
             <div class="panel">
                 <h3 class="title-tag">ğŸ‡ºğŸ‡¸ Ø£Ø³Ø¹Ø§Ø± Ø¬Ø±Ø§Ù… Ø§Ù„Ø°Ù‡Ø¨ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 24</div><div class="priceLabel" data-karat="24" id="usd_24k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 22</div><div class="priceLabel" data-karat="22" id="usd_22k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 21</div><div class="priceLabel" data-karat="21" id="usd_21k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 18</div><div class="priceLabel" data-karat="18" id="usd_18k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 14</div><div class="priceLabel" data-karat="14" id="usd_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
             <div class="panel">
                 <h3 class="title-tag">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 24</div><div class="priceLabel" data-karat="24" id="sar_24k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 22</div><div class="priceLabel" data-karat="22" id="sar_22k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 21</div><div class="priceLabel" data-karat="21" id="sar_21k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 18</div><div class="priceLabel" data-karat="18" id="sar_18k_price_value">---</div>
                         <div class="karat-label">Ø¹ÙŠØ§Ø± 14</div><div class="priceLabel" data-karat="14" id="sar_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
         </div>
 
         <!-- âš–ï¸ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© -->
         <div class="panel">
             <h2 class="title-tag">âš–ï¸ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
             <div class="calculator-card">
                 <div class="input-group">
                     <label for="weight_value_input" class="calc-label">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù† Ø¨Ø§Ù„Ø¬Ø±Ø§Ù…:</label>
                     <input type="number" id="weight_value_input" step="0.001" min="0" placeholder="0.000">
                     <button id="clear_calc_button" class="clear">Ù…Ø³Ø­</button>
                 </div>
                 <div class="separator"></div>
                 <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;" id="value-calc-grid">
                     <div class="calc-grid-header">Ø§Ù„Ø¹ÙŠØ§Ø±</div>
                     <div class="calc-grid-header">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</div>
                     <div class="calc-grid-header">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ</div>
                     <div class="calc-grid-header">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</div>
                 </div>
             </div>
         </div>
         
         <!-- âš–ï¸ Ø­Ø§Ø³Ø¨Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ÙˆØ²Ø§Ù† -->
         <div class="panel">
             <h2 class="title-tag">âš–ï¸ Ø­Ø§Ø³Ø¨Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø¨ÙŠÙ† Ø§Ù„Ø¹ÙŠØ§Ø±Ø§Øª</h2>
             <div class="calculator-card">
                 <div class="input-group">
                     <label for="source_weight_input" class="calc-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¬Ø±Ø§Ù…):</label>
                     <input type="number" id="source_weight_input" step="0.001" min="0" placeholder="0.000">
                     <label for="source_karat_selector" class="calc-label">Ø§Ù„Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                     <select id="source_karat_selector"></select>
                     <button id="clear_conv_button" class="clear">Ù…Ø³Ø­</button>
                 </div>
                 <div class="separator"></div>
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" id="conversion-calc-grid">
                     <div class="calc-grid-header">Ø§Ù„Ø¹ÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„ Ø¥Ù„ÙŠÙ‡</div>
                     <div class="calc-grid-header">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¬Ø±Ø§Ù…)</div>
                 </div>
             </div>
         </div>
 
         <!-- âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
         <div class="panel">
             <h2 class="title-tag">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h2>
             <div class="settings-card">
                 <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                     <label for="exchange_rate_input" class="setting-label">Ø³Ø¹Ø± ØµØ±Ù Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ù‚Ø§Ø¨Ù„ 1 Ø¯ÙˆÙ„Ø§Ø±:</label>
                     <input type="number" id="exchange_rate_input" step="0.01" min="0">
                     <label for="sar_exchange_rate_input" class="setting-label">Ø³Ø¹Ø± ØµØ±Ù Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ù…Ù‚Ø§Ø¨Ù„ 1 Ø¯ÙˆÙ„Ø§Ø±:</label>
                     <input type="number" id="sar_exchange_rate_input" step="0.0001" min="0">
                 </div>
                 <div class="separator"></div>
                 <label for="api_key_input" class="api-label">Ù…ÙØªØ§Ø­ Finnhub API:</label>
                 <div style="display: flex; gap: 10px;">
                     <input type="password" id="api_key_input">
                     <button id="visibility_button">Ø¥Ø¸Ù‡Ø§Ø±</button>
                 </div>
                 <div class="api-actions">
                     <div class="button-group" style="flex-grow: 0;">
                         <button id="copy_api_key" style="padding: 10px 15px;">Ù†Ø³Ø®</button>
                         <button id="paste_api_key" style="padding: 10px 15px;">Ù„ØµÙ‚</button>
                         <button id="clear_api_key" class="clear" style="padding: 10px 15px;">Ù…Ø³Ø­</button>
                     </div>
                     <div class="api-links">
                         <a href="https://finnhub.io/dashboard" target="_blank">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­</a>
                         <a href="https://finnhub.io/" target="_blank">Ù…ÙˆÙ‚Ø¹ Finnhub</a>
                     </div>
                 </div>
                 <div class="separator"></div>
                 <div class="button-group">
                     <button id="save_button">Ø­ÙØ¸ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„</button>
                     <button id="reset_defaults_button" class="reset">Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                     <button id="connection_button">Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„</button>
                 </div>
             </div>
         </div>
    </div>
    
    <div class="custom-tooltip"></div> <!-- Tooltip element added once to the body -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const OUNCE_TO_GRAM = 31.1035;
            const KARAT_PURITIES = {"24": 1.0, "22": 22/24, "21": 21/24, "18": 18/24, "14": 14/24};
            const DEFAULTS = {
                API_KEY: "d39dgphr01ql85dhacpgd39dgphr01ql85dhacq0",
                EXCHANGE_RATE: 535.0,
                SAR_RATE: 3.75
            };
            
            let lastGoldPriceUsd = 0.0;
            let websocket = null;
            let isConnected = false;
 
            const elements = {
                statusLabel: document.getElementById('status_label'),
                marketStatusLabel: document.getElementById('market_status_label'),
                sessionStatusLabel: document.getElementById('session_status_label'),
                lastUpdateLabel: document.getElementById('last_update_label'),
                globalPriceFrame: document.getElementById('global_price_frame'),
                globalPriceValue: document.getElementById('global_price_value'),
                upArrow: document.getElementById('up_arrow'),
                downArrow: document.getElementById('down_arrow'),
                apiKeyInput: document.getElementById('api_key_input'),
                exchangeRateInput: document.getElementById('exchange_rate_input'),
                sarExchangeRateInput: document.getElementById('sar_exchange_rate_input'),
                weightValueInput: document.getElementById('weight_value_input'),
                valueCalcGrid: document.getElementById('value-calc-grid'),
                sourceWeightInput: document.getElementById('source_weight_input'),
                sourceKaratSelector: document.getElementById('source_karat_selector'),
                conversionCalcGrid: document.getElementById('conversion-calc-grid'),
                connectionButton: document.getElementById('connection_button'),
                visibilityButton: document.getElementById('visibility_button'),
                tooltip: document.querySelector('.custom-tooltip')
            };

            const dateTimeHandler = {
                dayNames: ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"],
                gregorianMonths: ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"],
                
                toHijri: function(gy, gm, gd) {
                    let d = new Date(gy, gm - 1, gd);
                    let i = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-civil', {day: 'numeric', month: 'long', year: 'numeric'}).format(d);
                    return i.replace('Ù‡Ù€', '').trim();
                },

                getFormattedDatetimeString: function() {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                    const dayName = this.dayNames[now.getDay()];
                    const gregMonth = this.gregorianMonths[now.getMonth()];
                    const hijriDateParts = this.toHijri(now.getFullYear(), now.getMonth() + 1, now.getDate()).split(' ');
                    const hijriDay = hijriDateParts[0];
                    const hijriMonth = hijriDateParts[1];
                    const hijriYear = hijriDateParts[2];
                    return `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeStr} | ${dayName} | Ù…ÙŠÙ„Ø§Ø¯ÙŠ: ${now.getDate()} ${gregMonth} ${now.getFullYear()} | Ù‡Ø¬Ø±ÙŠ: ${hijriDay} ${hijriMonth} ${hijriYear}`;
                },
                getMarketStatus: function() {
                    const day = new Date().getDay();
                    const dayName = this.dayNames[day];
                    return (day === 0 || day === 6) ? [`${dayName} : Ù…ØºÙ„Ù‚`, "closed"] : [`${dayName} : Ù…ÙØªÙˆØ­`, "open"];
                },
                getTradingSessionStatus: function() {
                    const now = new Date();
                    const day = now.getDay();
                    if (day === 0 || day === 6) return ["Ø§Ù„Ø³ÙˆÙ‚ Ù…ØºÙ„Ù‚", "closed"];
                    const hour = now.getUTCHours() + 3; // Convert to GMT+3
                    const currentHour = hour >= 24 ? hour - 24 : hour;
                    if (currentHour >= 11 && currentHour < 19) return ["ğŸ‘‘ ÙØªØ±Ø© Ø§Ù„Ø°Ø±ÙˆØ©", "peak"];
                    if (currentHour >= 19 || currentHour < 1) return ["â³ ÙØªØ±Ø© Ù†Ø´Ø·Ø©", "active"];
                    if (currentHour >= 1 && currentHour < 7) return ["ğŸ˜´ ÙØªØ±Ø© Ù‡Ø§Ø¯Ø¦Ø©", "calm"];
                    if (currentHour >= 7 && currentHour < 11) return ["â†—ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø·", "warmup"];
                    return ["ØºÙŠØ± Ù…Ø­Ø¯Ø¯", "unknown"];
                }
            };
             
            const marketTooltipHTML = `<h4>Ø¬Ø¯ÙˆÙ„ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚</h4><table><thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚</th></tr></thead><tbody><tr><td>Ø§Ù„Ø³Ø¨Øª</td><td class="highlight-red">âŒ Ù…ØºÙ„Ù‚</td></tr><tr><td>Ø§Ù„Ø£Ø­Ø¯</td><td class="highlight-red">âŒ Ù…ØºÙ„Ù‚</td></tr><tr><td>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</td><td class="highlight-green">âœ… Ù…ÙØªÙˆØ­</td></tr><tr><td>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</td><td class="highlight-green">âœ… Ù…ÙØªÙˆØ­</td></tr><tr><td>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</td><td class="highlight-green">âœ… Ù…ÙØªÙˆØ­</td></tr><tr><td>Ø§Ù„Ø®Ù…ÙŠØ³</td><td class="highlight-green">âœ… Ù…ÙØªÙˆØ­</td></tr><tr><td>Ø§Ù„Ø¬Ù…Ø¹Ø©</td><td class="highlight-green">âœ… Ù…ÙØªÙˆØ­</td></tr></tbody></table><h4>Ù…Ù„Ø®Øµ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„:</h4><ul><li><b>Ø§Ù„Ø£ÙŠØ§Ù…:</b> Ù…Ù† Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…Ø¹Ø©.</li><li><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> Ø§Ù„Ø³ÙˆÙ‚ Ù…ÙØªÙˆØ­ 24 Ø³Ø§Ø¹Ø©.</li><li><b>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</b> ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø³Ø¨Øª ÙˆØ§Ù„Ø£Ø­Ø¯.</li></ul><h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</h4><ul><li>ÙŠÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ ÙŠÙˆÙ… Ø§Ù„Ø¥Ø«Ù†ÙŠÙ† Ù…Ø¹ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ø³ÙŠÙˆÙŠØ©.</li><li>ÙŠÙØºÙ„Ù‚ Ø§Ù„Ø³ÙˆÙ‚ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© Ù…Ø¹ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ©.</li></ul>`;
            const sessionTooltipHTML = `<h4>Ø£ÙˆÙ‚Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ (Ø¨ØªÙˆÙ‚ÙŠØª GMT+3)</h4><table><thead><tr><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th><th>ÙˆØµÙ Ø§Ù„Ù†Ø´Ø§Ø·</th></tr></thead><tbody><tr><td>ğŸ‘‘ ÙØªØ±Ø© Ø§Ù„Ø°Ø±ÙˆØ© (Ø§Ù„Ø£ÙØ¶Ù„)</td><td>11:00 ØµØ¨Ø§Ø­Ù‹Ø§ - 7:00 Ù…Ø³Ø§Ø¡Ù‹</td><td>Ø£Ù‚ÙˆÙ‰ Ø­Ø±ÙƒØ© Ù„Ù„Ø³Ø¹Ø± (ØªØ¯Ø§Ø®Ù„ Ù„Ù†Ø¯Ù† ÙˆÙ†ÙŠÙˆÙŠÙˆØ±Ùƒ).</td></tr><tr><td>â³ ÙØªØ±Ø© Ù†Ø´Ø·Ø©</td><td>7:00 Ù…Ø³Ø§Ø¡Ù‹ - 1:00 ØµØ¨Ø§Ø­Ù‹Ø§</td><td>Ø¬Ù„Ø³Ø© Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ ÙˆØ­Ø¯Ù‡Ø§ØŒ Ø­Ø±ÙƒØ© Ø¬ÙŠØ¯Ø©.</td></tr><tr><td>ğŸ˜´ ÙØªØ±Ø© Ù‡Ø§Ø¯Ø¦Ø©</td><td>1:00 ØµØ¨Ø§Ø­Ù‹Ø§ - 7:00 ØµØ¨Ø§Ø­Ù‹Ø§</td><td>Ø£Ø¶Ø¹Ù Ø­Ø±ÙƒØ© Ù„Ù„Ø³Ø¹Ø± (Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ø³ÙŠÙˆÙŠØ©).</td></tr><tr><td>â†—ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø·</td><td>7:00 ØµØ¨Ø§Ø­Ù‹Ø§ - 11:00 ØµØ¨Ø§Ø­Ù‹Ø§</td><td>Ø¨Ø¯Ø§ÙŠØ© Ø¢Ø³ÙŠØ§ ÙˆØ§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ø§ÙØªØªØ§Ø­ Ù„Ù†Ø¯Ù†.</td></tr></tbody></table><h4 class="highlight-orange">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:</h4><ul><li>ØªØ¹ØªÙ…Ø¯ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„ØµÙŠÙÙŠ/Ø§Ù„Ø´ØªÙˆÙŠ ÙˆÙ‚Ø¯ ØªØªØºÙŠØ±.</li><li>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© Ù‡ÙŠ Ø§Ù„Ø£Ø¶Ø¹Ù Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø¹Ø±.</li></ul><h4 class="highlight-green">Ø§Ù„Ø®Ù„Ø§ØµØ©:</h4><p>Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‚ØµÙ‰ Ø§Ø³ØªÙØ§Ø¯Ø©ØŒ Ø±ÙƒØ² Ø¹Ù„Ù‰ <b>ÙØªØ±Ø© Ø§Ù„Ø°Ø±ÙˆØ© (11 ØµØ¨Ø§Ø­Ù‹Ø§ - 7 Ù…Ø³Ø§Ø¡Ù‹)</b>ØŒ ÙÙ‡ÙŠ Ù‚Ù„Ø¨ Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.</p>`;

            // ===== Smart Tooltip Logic =====
            function showTooltip(targetElement, htmlContent) {
                const tooltip = elements.tooltip;
                tooltip.innerHTML = htmlContent;
                tooltip.classList.add('visible');

                const rect = targetElement.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const spacing = 8;

                let top = rect.bottom + window.scrollY + spacing;
                let left = rect.left + window.scrollX;

                // Check for horizontal overflow
                if (left + tooltipRect.width > viewportWidth) {
                    left = rect.right + window.scrollX - tooltipRect.width;
                }
                
                // Ensure it doesn't go off the left side of the screen
                if (left < 0) {
                    left = spacing;
                }
                
                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
            }

            function hideTooltip() {
                elements.tooltip.classList.remove('visible');
            }
            
            elements.marketStatusLabel.addEventListener('mouseenter', (e) => showTooltip(e.target, marketTooltipHTML));
            elements.marketStatusLabel.addEventListener('mouseleave', hideTooltip);

            elements.sessionStatusLabel.addEventListener('mouseenter', (e) => showTooltip(e.target, sessionTooltipHTML));
            elements.sessionStatusLabel.addEventListener('mouseleave', hideTooltip);
            
            // --- UI UPDATES ---
            function updateStatusMessage(status, text) {
                elements.statusLabel.setAttribute('status', status);
                elements.statusLabel.textContent = text;
                
                if(status === 'connected'){
                    elements.connectionButton.classList.add('connected');
                    elements.connectionButton.textContent = "Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„";
                    isConnected = true;
                } else {
                    elements.connectionButton.classList.remove('connected');
                    elements.connectionButton.textContent = "Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„";
                    isConnected = false;
                }
            }
 
            function updateAllStatuses() {
                const [marketText, marketStatus] = dateTimeHandler.getMarketStatus();
                elements.marketStatusLabel.textContent = marketText;
                elements.marketStatusLabel.setAttribute('status', marketStatus);
 
                const [sessionText, sessionStatus] = dateTimeHandler.getTradingSessionStatus();
                elements.sessionStatusLabel.textContent = sessionText;
                elements.sessionStatusLabel.setAttribute('status', sessionStatus);
            }
 
            function updatePriceLabel(price) {
                let priceChangeState = "none";
                if (lastGoldPriceUsd > 0) {
                    if (price > lastGoldPriceUsd) priceChangeState = "up";
                    else if (price < lastGoldPriceUsd) priceChangeState = "down";
                }
 
                if (priceChangeState !== "none") {
                    elements.globalPriceFrame.classList.add(priceChangeState === "up" ? "price-up" : "price-down");
                    elements.upArrow.style.display = priceChangeState === "up" ? 'block' : 'none';
                    elements.downArrow.style.display = priceChangeState === "down" ? 'block' : 'none';
                    setTimeout(() => {
                        elements.globalPriceFrame.classList.remove("price-up", "price-down");
                    }, 800);
                }
 
                lastGoldPriceUsd = price;
                elements.globalPriceValue.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                elements.lastUpdateLabel.textContent = dateTimeHandler.getFormattedDatetimeString();
 
                calculateAndDisplayPrices();
                updateWeightValueCalculations();
            }
 
            // --- CALCULATIONS ---
            function calculateAndDisplayPrices() {
                if (lastGoldPriceUsd <= 0) return;
                const pricePerGramUsd24k = lastGoldPriceUsd / OUNCE_TO_GRAM;
                const exchangeRate = parseFloat(elements.exchangeRateInput.value) || 0;
                const sarRate = parseFloat(elements.sarExchangeRateInput.value) || 0;
 
                for (const karat in KARAT_PURITIES) {
                    const purity = KARAT_PURITIES[karat];
                    const pricePerGramKaratUsd = pricePerGramUsd24k * purity;
 
                    document.getElementById(`usd_${karat}k_price_value`).textContent = `$${pricePerGramKaratUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById(`local_${karat}k_price_value`).textContent = (pricePerGramKaratUsd * exchangeRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    document.getElementById(`sar_${karat}k_price_value`).textContent = (pricePerGramKaratUsd * sarRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            }
 
            function updateWeightValueCalculations() {
                const weight = parseFloat(elements.weightValueInput.value);
                while (elements.valueCalcGrid.children.length > 4) {
                    elements.valueCalcGrid.removeChild(elements.valueCalcGrid.lastChild);
                }
 
                if (lastGoldPriceUsd <= 0 || !weight || weight <= 0) return;
 
                const pricePerGram24kUsd = lastGoldPriceUsd / OUNCE_TO_GRAM;
                const exchangeRate = parseFloat(elements.exchangeRateInput.value) || 0;
                const sarRate = parseFloat(elements.sarExchangeRateInput.value) || 0;
 
                for (const karat in KARAT_PURITIES) {
                    const purity = KARAT_PURITIES[karat];
                    const pricePerGramKaratUsd = pricePerGram24kUsd * purity;
                    const totalUsd = weight * pricePerGramKaratUsd;
                    const totalLocal = totalUsd * exchangeRate;
                    const totalSar = totalUsd * sarRate;
 
                    const karatLabel = document.createElement('div');
                    karatLabel.className = 'calc-karat-label';
                    karatLabel.textContent = `Ø¹ÙŠØ§Ø± ${karat}`;
 
                    const localResult = document.createElement('div');
                    localResult.className = 'calc-grid-result';
                    localResult.textContent = totalLocal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
 
                    const usdResult = document.createElement('div');
                    usdResult.className = 'calc-grid-result';
                    usdResult.textContent = `$${totalUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
 
                    const sarResult = document.createElement('div');
                    sarResult.className = 'calc-grid-result';
                    sarResult.textContent = `${totalSar.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Ø±.Ø³`;
                     
                    elements.valueCalcGrid.append(karatLabel, localResult, usdResult, sarResult);
                }
            }
             
            function updateWeightConversionCalculations() {
                const sourceWeight = parseFloat(elements.sourceWeightInput.value);
                const sourceKarat = elements.sourceKaratSelector.value;
                while (elements.conversionCalcGrid.children.length > 2) {
                    elements.conversionCalcGrid.removeChild(elements.conversionCalcGrid.lastChild);
                }
 
                if (!sourceKarat || !sourceWeight || sourceWeight <= 0) return;
 
                const sourcePurity = KARAT_PURITIES[sourceKarat];
                const pureGoldMass = sourceWeight * sourcePurity;
 
                for (const targetKarat in KARAT_PURITIES) {
                    const targetPurity = KARAT_PURITIES[targetKarat];
                    const newWeight = pureGoldMass / targetPurity;
 
                    const label = document.createElement('div');
                    label.className = 'calc-karat-label';
                    label.textContent = `Ø§Ù„ÙˆØ²Ù† Ø¨Ø¹ÙŠØ§Ø± ${targetKarat}:`;
                     
                    const result = document.createElement('div');
                    result.className = 'calc-grid-result';
                    result.textContent = `${newWeight.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} Ø¬Ø±Ø§Ù…`;
 
                    elements.conversionCalcGrid.append(label, result);
                }
            }
 
            // --- WEBSOCKET ---
            function connect() {
                const apiKey = elements.apiKeyInput.value;
                if (!apiKey) {
                    updateStatusMessage('error', 'Ù…ÙØªØ§Ø­ API ÙØ§Ø±Øº!');
                    return;
                }
                
                disconnect(); // Ensure any existing connection is closed before opening a new one
                websocket = new WebSocket(`wss://ws.finnhub.io?token=${apiKey}`);
                updateStatusMessage('connecting', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...');
 
                websocket.onopen = () => {
                    websocket.send(JSON.stringify({'type':'subscribe', 'symbol': 'OANDA:XAU_USD'}));
                    updateStatusMessage('connected', 'Ù…ØªØµÙ„');
                };
 
                websocket.onmessage = (event) => {
                    try {
                       const data = JSON.parse(event.data);
                       if (data.type === 'trade' && data.data && data.data.length > 0) {
                           updatePriceLabel(data.data[0].p);
                       }
                    } catch(e) {
                        console.error("Error parsing websocket message", e);
                    }
                };
 
                websocket.onclose = () => {
                    if (isConnected) { // Only show message if it was previously connected
                        updateStatusMessage('disconnected', 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
                    }
                };
 
                websocket.onerror = (error) => {
                    console.error("WebSocket Error:", error);
                    updateStatusMessage('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                };
            }
 
            function disconnect() {
                if (websocket) {
                    websocket.onclose = null; // prevent onclose from firing on manual disconnect
                    websocket.close();
                    websocket = null;
                }
                updateStatusMessage('disconnected', 'ØºÙŠØ± Ù…ØªØµÙ„');
            }
 
            // --- SETTINGS ---
            function saveSettings() {
                localStorage.setItem('goldAppData', JSON.stringify({
                    apiKey: elements.apiKeyInput.value,
                    exchangeRate: elements.exchangeRateInput.value,
                    sarRate: elements.sarExchangeRateInput.value
                }));
            }
 
            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('goldAppData'));
                elements.apiKeyInput.value = settings?.apiKey || DEFAULTS.API_KEY;
                elements.exchangeRateInput.value = settings?.exchangeRate || DEFAULTS.EXCHANGE_RATE;
                elements.sarExchangeRateInput.value = settings?.sarRate || DEFAULTS.SAR_RATE;
            }
 
            // --- EVENT LISTENERS ---
            elements.connectionButton.addEventListener('click', () => {
                isConnected ? disconnect() : connect();
            });
 
            document.getElementById('save_button').addEventListener('click', () => {
                saveSettings();
                updateStatusMessage('connecting', 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                setTimeout(connect, 250);
            });
 
            document.getElementById('reset_defaults_button').addEventListener('click', () => {
                elements.apiKeyInput.value = DEFAULTS.API_KEY;
                elements.exchangeRateInput.value = DEFAULTS.EXCHANGE_RATE;
                elements.sarExchangeRateInput.value = DEFAULTS.SAR_RATE;
                saveSettings();
                updateStatusMessage('connecting', 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                setTimeout(connect, 250);
            });
 
            elements.visibilityButton.addEventListener('click', () => {
                const isPassword = elements.apiKeyInput.type === 'password';
                elements.apiKeyInput.type = isPassword ? 'text' : 'password';
                elements.visibilityButton.textContent = isPassword ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±';
                elements.visibilityButton.classList.toggle('visible', isPassword);
            });
 
            document.getElementById('copy_api_key').addEventListener('click', () => navigator.clipboard.writeText(elements.apiKeyInput.value));
            document.getElementById('paste_api_key').addEventListener('click', async () => elements.apiKeyInput.value = await navigator.clipboard.readText());
            document.getElementById('clear_api_key').addEventListener('click', () => elements.apiKeyInput.value = '');
 
            elements.weightValueInput.addEventListener('input', updateWeightValueCalculations);
            document.getElementById('clear_calc_button').addEventListener('click', () => {
                elements.weightValueInput.value = '';
                updateWeightValueCalculations();
            });
 
            elements.sourceWeightInput.addEventListener('input', updateWeightConversionCalculations);
            elements.sourceKaratSelector.addEventListener('change', updateWeightConversionCalculations);
            document.getElementById('clear_conv_button').addEventListener('click', () => {
                elements.sourceWeightInput.value = '';
                updateWeightConversionCalculations();
            });
             
            document.querySelectorAll('.priceLabel, #global_price_value').forEach(label => {
                label.addEventListener('dblclick', () => {
                    const text = label.textContent.replace(/[$,\sØ±.Ø³]/g, '').trim();
                    if (text && !isNaN(text)) {
                        navigator.clipboard.writeText(text);
                        label.classList.add('copied');
                        setTimeout(() => label.classList.remove('copied'), 500);
                    }
                });
            });
 
            // --- INITIALIZATION ---
            function initialize() {
                Object.keys(KARAT_PURITIES).forEach(karat => {
                    const option = new Option(`Ø¹ÙŠØ§Ø± ${karat}`, karat);
                    elements.sourceKaratSelector.add(option);
                });
                elements.sourceKaratSelector.value = "21";
 
                loadSettings();
                updateAllStatuses();
                setInterval(updateAllStatuses, 60000); 
                 
                updateWeightConversionCalculations();
                updateWeightValueCalculations();
                 
                connect();
            }
 
            initialize();
        });
    </script>
</body>
</html>