<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مؤشر أسعار الذهب (تحديث لحظي)</title>
    <style>
        /* ===== الخطوط والأساسيات ===== */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #2c3e50, #34495e);
            color: #ecf0f1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== التنسيقات العامة ===== */
        .container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: linear-gradient(to bottom, #4a6582, #3a5572);
            border-radius: 15px;
            border: 1px solid #5a7592;
            padding: 10px 20px 20px 20px;
        }

        .title-tag {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            font-weight: bold;
            padding: 10px 25px;
            border-radius: 15px;
            font-size: 26px;
            border: 2px solid #5dade2;
            text-align: center;
            margin: 0 auto 15px auto;
            display: table;
        }

        /* ===== لوحة السعر العالمي ===== */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        #status_label, #market_status_label, #session_status_label {
            font-weight: bold;
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            transition: background 0.3s ease;
            cursor: help;
        }

        #status_label[status="connected"], #market_status_label[status="open"] {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
        }
        #status_label[status="disconnected"], #market_status_label[status="closed"], #session_status_label[status="closed"] {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }
        #status_label[status="connecting"], #status_label[status="error"] {
            background: linear-gradient(to bottom, #f39c12, #e67e22);
        }
        #session_status_label[status="peak"] { background: linear-gradient(to bottom, #f39c12, #d35400); }
        #session_status_label[status="active"] { background: linear-gradient(to bottom, #3498db, #2980b9); }
        #session_status_label[status="warmup"] { background: linear-gradient(to bottom, #1abc9c, #16a085); }
        #session_status_label[status="calm"] { background: linear-gradient(to bottom, #95a5a6, #7f8c8d); }

        #last_update_label {
            font-size: 16px;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 5px 10px;
            border-radius: 10px;
        }

        #global_price_frame {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border: 4px solid #e74c3c;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        #global_price_frame.price-up {
            background: linear-gradient(to bottom, #d4efdf, #f8f9fa);
            border-color: #2ecc71;
        }

        #global_price_frame.price-down {
            background: linear-gradient(to bottom, #fdedec, #f8f9fa);
            border-color: #e74c3c;
        }

        #global_price_title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .price-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        #global_price_value {
            font-size: 76px;
            font-weight: bold;
            color: #34495e;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        #up_arrow, #down_arrow {
            font-size: 40px; 
            font-weight: bold; 
            display: none;
        }
        #up_arrow { color: #2ecc71; }
        #down_arrow { color: #e74c3c; }

        /* ===== بطاقات الأسعار ===== */
        .prices-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .price-card {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 15px;
            transition: border-color 0.3s ease;
        }

        .price-card:hover {
            border-color: #3498db;
        }

        .price-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 12px;
        }

        .karat-label {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .priceLabel {
            font-size: 35px;
            font-weight: bold;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .priceLabel.copied {
            border-color: #2ecc71;
        }

        [data-karat="24"] { color: #27ae60; }
        [data-karat="22"] { color: #d35400; }
        [data-karat="21"] { color: #f39c12; }
        [data-karat="18"] { color: #8e44ad; }
        [data-karat="14"] { color: #2980b9; }

        /* ===== الإعدادات والحاسبات ===== */
        .settings-card, .calculator-card {
            background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 20px;
            color: #2c3e50;
        }

        .setting-label, .api-label, .calc-label {
            font-weight: bold;
            font-size: 18px;
        }

        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            background: #ffffff;
            color: #2c3e50;
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: #3498db;
            background: #f8f9fa;
            outline: none;
        }

        .separator {
            border-top: 2px solid #dfe6e9;
            margin: 20px 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white; 
            font-weight: bold; 
            border: none; 
            padding: 14px 25px;
            border-radius: 10px; 
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: background 0.3s, border-color 0.3s;
            flex-grow: 1;
        }

        button:hover {
            background: linear-gradient(to bottom, #4eaadd, #3498db);
        }

        button:active {
            background: linear-gradient(to bottom, #2980b9, #1c5a85);
        }
        
        button.reset, button.clear {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
        }
        button.reset:hover, button.clear:hover {
            background: linear-gradient(to bottom, #b3b6b7, #95a5a6);
        }

        #connection_button.connected {
             background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }

        #visibility_button.visible {
            background: linear-gradient(to bottom, #f39c12, #d35400);
        }

        .api-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .api-links a {
            color: #000000;
            text-decoration: underline;
            margin-right: 15px;
        }
        .api-links a:hover {
            color: #5dade2;
        }

        /* ===== الحاسبات ===== */
        .calc-grid-header {
            font-weight: bold;
            font-size: 16px;
            background-color: #95a5a6;
            color: #2c3e50;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .calc-grid-result {
            font-size: 20px;
            font-weight: bold;
            background-color: #ecf0f1;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            text-align: center;
            min-height: 30px; /* To prevent layout shift */
        }

        .calc-karat-label {
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            padding-top: 8px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group .calc-label {
            flex-shrink: 0;
        }
        .input-group input, .input-group select {
            flex-grow: 1;
            min-width: 150px;
        }
        .input-group button {
            flex-shrink: 0;
            padding: 12px 20px;
        }

        /* ===== Custom Tooltip ===== */
        .custom-tooltip {
            position: absolute;
            visibility: hidden; /* Use visibility for smooth transitions */
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #4a6582;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 1000;
            max-width: 550px; /* Increased max-width */
            min-width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            line-height: 1.6;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .custom-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        .custom-tooltip h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 18px;
        }
        .custom-tooltip table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            text-align: center;
            background-color: #4a6582;
            border: 1px solid #5a7592;
        }
        .custom-tooltip th, .custom-tooltip td {
            border: 1px solid #5a7592;
            padding: 6px;
        }
        .custom-tooltip th {
            background-color: #2c3e50;
        }
        .custom-tooltip ul {
            padding-right: 20px;
            margin: 10px 0;
        }
        .custom-tooltip .highlight-green { color: #2ecc71; }
        .custom-tooltip .highlight-red { color: #e74c3c; }
        .custom-tooltip .highlight-orange { color: #f39c12; }
    </style>
</head>
<body>

    <div class="container">
         <!-- 🏆 السعر العالمي للذهب -->
         <div class="panel">
             <h2 class="title-tag">🏆 السعر العالمي للذهب (XAU/USD)</h2>
             <div class="top-bar">
                 <div id="status_label" status="connecting">جاري الاتصال...</div>
                 <div id="market_status_label" status="">...</div>
                 <div id="session_status_label" status="">...</div>
                 <div style="flex-grow: 1;"></div>
                 <div id="last_update_label">...</div>
             </div>
             <div id="global_price_frame">
                 <div id="global_price_title">سعر الأونصة بالدولار الأمريكي</div>
                 <div class="price-container">
                     <div id="global_price_value">$0.00</div>
                     <div id="up_arrow">▲</div>
                     <div id="down_arrow">▼</div>
                 </div>
             </div>
         </div>
 
         <!-- 💵 أسعار العملات -->
         <div class="prices-layout">
             <div class="panel">
                 <h3 class="title-tag">💵 الأسعار بالعملة المحلية</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">عيار 24</div><div class="priceLabel" data-karat="24" id="local_24k_price_value">---</div>
                         <div class="karat-label">عيار 22</div><div class="priceLabel" data-karat="22" id="local_22k_price_value">---</div>
                         <div class="karat-label">عيار 21</div><div class="priceLabel" data-karat="21" id="local_21k_price_value">---</div>
                         <div class="karat-label">عيار 18</div><div class="priceLabel" data-karat="18" id="local_18k_price_value">---</div>
                         <div class="karat-label">عيار 14</div><div class="priceLabel" data-karat="14" id="local_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
             <div class="panel">
                 <h3 class="title-tag">🇺🇸 أسعار جرام الذهب بالدولار</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">عيار 24</div><div class="priceLabel" data-karat="24" id="usd_24k_price_value">---</div>
                         <div class="karat-label">عيار 22</div><div class="priceLabel" data-karat="22" id="usd_22k_price_value">---</div>
                         <div class="karat-label">عيار 21</div><div class="priceLabel" data-karat="21" id="usd_21k_price_value">---</div>
                         <div class="karat-label">عيار 18</div><div class="priceLabel" data-karat="18" id="usd_18k_price_value">---</div>
                         <div class="karat-label">عيار 14</div><div class="priceLabel" data-karat="14" id="usd_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
             <div class="panel">
                 <h3 class="title-tag">🇸🇦 الأسعار بالريال السعودي</h3>
                 <div class="price-card">
                     <div class="price-grid">
                         <div class="karat-label">عيار 24</div><div class="priceLabel" data-karat="24" id="sar_24k_price_value">---</div>
                         <div class="karat-label">عيار 22</div><div class="priceLabel" data-karat="22" id="sar_22k_price_value">---</div>
                         <div class="karat-label">عيار 21</div><div class="priceLabel" data-karat="21" id="sar_21k_price_value">---</div>
                         <div class="karat-label">عيار 18</div><div class="priceLabel" data-karat="18" id="sar_18k_price_value">---</div>
                         <div class="karat-label">عيار 14</div><div class="priceLabel" data-karat="14" id="sar_14k_price_value">---</div>
                     </div>
                 </div>
             </div>
         </div>
 
         <!-- ⚖️ حاسبة القيمة الشاملة -->
         <div class="panel">
             <h2 class="title-tag">⚖️ حاسبة القيمة الشاملة</h2>
             <div class="calculator-card">
                 <div class="input-group">
                     <label for="weight_value_input" class="calc-label">أدخل الوزن بالجرام:</label>
                     <input type="number" id="weight_value_input" step="0.001" min="0" placeholder="0.000">
                     <button id="clear_calc_button" class="clear">مسح</button>
                 </div>
                 <div class="separator"></div>
                 <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;" id="value-calc-grid">
                     <div class="calc-grid-header">العيار</div>
                     <div class="calc-grid-header">القيمة بالعملة المحلية</div>
                     <div class="calc-grid-header">القيمة بالدولار الأمريكي</div>
                     <div class="calc-grid-header">القيمة بالريال السعودي</div>
                 </div>
             </div>
         </div>
         
         <!-- ⚖️ حاسبة تحويل الأوزان -->
         <div class="panel">
             <h2 class="title-tag">⚖️ حاسبة تحويل الأوزان بين العيارات</h2>
             <div class="calculator-card">
                 <div class="input-group">
                     <label for="source_weight_input" class="calc-label">الوزن الحالي (جرام):</label>
                     <input type="number" id="source_weight_input" step="0.001" min="0" placeholder="0.000">
                     <label for="source_karat_selector" class="calc-label">العيار الحالي:</label>
                     <select id="source_karat_selector"></select>
                     <button id="clear_conv_button" class="clear">مسح</button>
                 </div>
                 <div class="separator"></div>
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" id="conversion-calc-grid">
                     <div class="calc-grid-header">العيار المحوّل إليه</div>
                     <div class="calc-grid-header">الوزن الجديد (جرام)</div>
                 </div>
             </div>
         </div>
 
         <!-- ⚙️ الإعدادات -->
         <div class="panel">
             <h2 class="title-tag">⚙️ الإعدادات والمساعدة</h2>
             <div class="settings-card">
                 <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                     <label for="exchange_rate_input" class="setting-label">سعر صرف العملة المحلية مقابل 1 دولار:</label>
                     <input type="number" id="exchange_rate_input" step="0.01" min="0">
                     <label for="sar_exchange_rate_input" class="setting-label">سعر صرف الريال السعودي مقابل 1 دولار:</label>
                     <input type="number" id="sar_exchange_rate_input" step="0.0001" min="0">
                 </div>
                 <div class="separator"></div>
                 <label for="api_key_input" class="api-label">مفتاح Finnhub API:</label>
                 <div style="display: flex; gap: 10px;">
                     <input type="password" id="api_key_input">
                     <button id="visibility_button">إظهار</button>
                 </div>
                 <div class="api-actions">
                     <div class="button-group" style="flex-grow: 0;">
                         <button id="copy_api_key" style="padding: 10px 15px;">نسخ</button>
                         <button id="paste_api_key" style="padding: 10px 15px;">لصق</button>
                         <button id="clear_api_key" class="clear" style="padding: 10px 15px;">مسح</button>
                     </div>
                     <div class="api-links">
                         <a href="https://finnhub.io/dashboard" target="_blank">الحصول على مفتاح</a>
                         <a href="https://finnhub.io/" target="_blank">موقع Finnhub</a>
                     </div>
                 </div>
                 <div class="separator"></div>
                 <div class="button-group">
                     <button id="save_button">حفظ وإعادة الاتصال</button>
                     <button id="reset_defaults_button" class="reset">إعادة للوضع الافتراضي</button>
                     <button id="connection_button">بدء الاتصال</button>
                 </div>
             </div>
         </div>
    </div>
    
    <div class="custom-tooltip"></div> <!-- Tooltip element added once to the body -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const OUNCE_TO_GRAM = 31.1035;
            const KARAT_PURITIES = {"24": 1.0, "22": 22/24, "21": 21/24, "18": 18/24, "14": 14/24};
            const DEFAULTS = {
                API_KEY: "d39dgphr01ql85dhacpgd39dgphr01ql85dhacq0",
                EXCHANGE_RATE: 535.0,
                SAR_RATE: 3.75
            };
            
            let lastGoldPriceUsd = 0.0;
            let websocket = null;
            let isConnected = false;
 
            const elements = {
                statusLabel: document.getElementById('status_label'),
                marketStatusLabel: document.getElementById('market_status_label'),
                sessionStatusLabel: document.getElementById('session_status_label'),
                lastUpdateLabel: document.getElementById('last_update_label'),
                globalPriceFrame: document.getElementById('global_price_frame'),
                globalPriceValue: document.getElementById('global_price_value'),
                upArrow: document.getElementById('up_arrow'),
                downArrow: document.getElementById('down_arrow'),
                apiKeyInput: document.getElementById('api_key_input'),
                exchangeRateInput: document.getElementById('exchange_rate_input'),
                sarExchangeRateInput: document.getElementById('sar_exchange_rate_input'),
                weightValueInput: document.getElementById('weight_value_input'),
                valueCalcGrid: document.getElementById('value-calc-grid'),
                sourceWeightInput: document.getElementById('source_weight_input'),
                sourceKaratSelector: document.getElementById('source_karat_selector'),
                conversionCalcGrid: document.getElementById('conversion-calc-grid'),
                connectionButton: document.getElementById('connection_button'),
                visibilityButton: document.getElementById('visibility_button'),
                tooltip: document.querySelector('.custom-tooltip')
            };

            const dateTimeHandler = {
                dayNames: ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"],
                gregorianMonths: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"],
                
                toHijri: function(gy, gm, gd) {
                    let d = new Date(gy, gm - 1, gd);
                    let i = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-civil', {day: 'numeric', month: 'long', year: 'numeric'}).format(d);
                    return i.replace('هـ', '').trim();
                },

                getFormattedDatetimeString: function() {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                    const dayName = this.dayNames[now.getDay()];
                    const gregMonth = this.gregorianMonths[now.getMonth()];
                    const hijriDateParts = this.toHijri(now.getFullYear(), now.getMonth() + 1, now.getDate()).split(' ');
                    const hijriDay = hijriDateParts[0];
                    const hijriMonth = hijriDateParts[1];
                    const hijriYear = hijriDateParts[2];
                    return `آخر تحديث: ${timeStr} | ${dayName} | ميلادي: ${now.getDate()} ${gregMonth} ${now.getFullYear()} | هجري: ${hijriDay} ${hijriMonth} ${hijriYear}`;
                },
                getMarketStatus: function() {
                    const day = new Date().getDay();
                    const dayName = this.dayNames[day];
                    return (day === 0 || day === 6) ? [`${dayName} : مغلق`, "closed"] : [`${dayName} : مفتوح`, "open"];
                },
                getTradingSessionStatus: function() {
                    const now = new Date();
                    const day = now.getDay();
                    if (day === 0 || day === 6) return ["السوق مغلق", "closed"];
                    const hour = now.getUTCHours() + 3; // Convert to GMT+3
                    const currentHour = hour >= 24 ? hour - 24 : hour;
                    if (currentHour >= 11 && currentHour < 19) return ["👑 فترة الذروة", "peak"];
                    if (currentHour >= 19 || currentHour < 1) return ["⏳ فترة نشطة", "active"];
                    if (currentHour >= 1 && currentHour < 7) return ["😴 فترة هادئة", "calm"];
                    if (currentHour >= 7 && currentHour < 11) return ["↗️ بداية النشاط", "warmup"];
                    return ["غير محدد", "unknown"];
                }
            };
             
            const marketTooltipHTML = `<h4>جدول أيام التداول وحالة السوق</h4><table><thead><tr><th>اليوم</th><th>حالة السوق</th></tr></thead><tbody><tr><td>السبت</td><td class="highlight-red">❌ مغلق</td></tr><tr><td>الأحد</td><td class="highlight-red">❌ مغلق</td></tr><tr><td>الإثنين</td><td class="highlight-green">✅ مفتوح</td></tr><tr><td>الثلاثاء</td><td class="highlight-green">✅ مفتوح</td></tr><tr><td>الأربعاء</td><td class="highlight-green">✅ مفتوح</td></tr><tr><td>الخميس</td><td class="highlight-green">✅ مفتوح</td></tr><tr><td>الجمعة</td><td class="highlight-green">✅ مفتوح</td></tr></tbody></table><h4>ملخص أوقات التداول:</h4><ul><li><b>الأيام:</b> من الاثنين إلى الجمعة.</li><li><b>الحالة:</b> السوق مفتوح 24 ساعة.</li><li><b>الإغلاق الأسبوعي:</b> يومي السبت والأحد.</li></ul><h4>معلومات إضافية:</h4><ul><li>يفتح السوق يوم الإثنين مع بداية الجلسة الآسيوية.</li><li>يُغلق السوق يوم الجمعة مع نهاية الجلسة الأمريكية.</li></ul>`;
            const sessionTooltipHTML = `<h4>أوقات تداول الذهب عالمياً (بتوقيت GMT+3)</h4><table><thead><tr><th>الفترة</th><th>التوقيت</th><th>وصف النشاط</th></tr></thead><tbody><tr><td>👑 فترة الذروة (الأفضل)</td><td>11:00 صباحًا - 7:00 مساءً</td><td>أقوى حركة للسعر (تداخل لندن ونيويورك).</td></tr><tr><td>⏳ فترة نشطة</td><td>7:00 مساءً - 1:00 صباحًا</td><td>جلسة نيويورك وحدها، حركة جيدة.</td></tr><tr><td>😴 فترة هادئة</td><td>1:00 صباحًا - 7:00 صباحًا</td><td>أضعف حركة للسعر (الجلسة الآسيوية).</td></tr><tr><td>↗️ بداية النشاط</td><td>7:00 صباحًا - 11:00 صباحًا</td><td>بداية آسيا والتحضير لافتتاح لندن.</td></tr></tbody></table><h4 class="highlight-orange">ملاحظات مهمة:</h4><ul><li>تعتمد الأوقات على التوقيت الصيفي/الشتوي وقد تتغير.</li><li>الفترة الهادئة هي الأضعف لحركة السعر.</li></ul><h4 class="highlight-green">الخلاصة:</h4><p>لتحقيق أقصى استفادة، ركز على <b>فترة الذروة (11 صباحًا - 7 مساءً)</b>، فهي قلب حركة السوق العالمية.</p>`;

            // ===== Smart Tooltip Logic =====
            function showTooltip(targetElement, htmlContent) {
                const tooltip = elements.tooltip;
                tooltip.innerHTML = htmlContent;
                tooltip.classList.add('visible');

                const rect = targetElement.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const spacing = 8;

                let top = rect.bottom + window.scrollY + spacing;
                let left = rect.left + window.scrollX;

                // Check for horizontal overflow
                if (left + tooltipRect.width > viewportWidth) {
                    left = rect.right + window.scrollX - tooltipRect.width;
                }
                
                // Ensure it doesn't go off the left side of the screen
                if (left < 0) {
                    left = spacing;
                }
                
                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
            }

            function hideTooltip() {
                elements.tooltip.classList.remove('visible');
            }
            
            elements.marketStatusLabel.addEventListener('mouseenter', (e) => showTooltip(e.target, marketTooltipHTML));
            elements.marketStatusLabel.addEventListener('mouseleave', hideTooltip);

            elements.sessionStatusLabel.addEventListener('mouseenter', (e) => showTooltip(e.target, sessionTooltipHTML));
            elements.sessionStatusLabel.addEventListener('mouseleave', hideTooltip);
            
            // --- UI UPDATES ---
            function updateStatusMessage(status, text) {
                elements.statusLabel.setAttribute('status', status);
                elements.statusLabel.textContent = text;
                
                if(status === 'connected'){
                    elements.connectionButton.classList.add('connected');
                    elements.connectionButton.textContent = "قطع الاتصال";
                    isConnected = true;
                } else {
                    elements.connectionButton.classList.remove('connected');
                    elements.connectionButton.textContent = "بدء الاتصال";
                    isConnected = false;
                }
            }
 
            function updateAllStatuses() {
                const [marketText, marketStatus] = dateTimeHandler.getMarketStatus();
                elements.marketStatusLabel.textContent = marketText;
                elements.marketStatusLabel.setAttribute('status', marketStatus);
 
                const [sessionText, sessionStatus] = dateTimeHandler.getTradingSessionStatus();
                elements.sessionStatusLabel.textContent = sessionText;
                elements.sessionStatusLabel.setAttribute('status', sessionStatus);
            }
 
            function updatePriceLabel(price) {
                let priceChangeState = "none";
                if (lastGoldPriceUsd > 0) {
                    if (price > lastGoldPriceUsd) priceChangeState = "up";
                    else if (price < lastGoldPriceUsd) priceChangeState = "down";
                }
 
                if (priceChangeState !== "none") {
                    elements.globalPriceFrame.classList.add(priceChangeState === "up" ? "price-up" : "price-down");
                    elements.upArrow.style.display = priceChangeState === "up" ? 'block' : 'none';
                    elements.downArrow.style.display = priceChangeState === "down" ? 'block' : 'none';
                    setTimeout(() => {
                        elements.globalPriceFrame.classList.remove("price-up", "price-down");
                    }, 800);
                }
 
                lastGoldPriceUsd = price;
                elements.globalPriceValue.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                elements.lastUpdateLabel.textContent = dateTimeHandler.getFormattedDatetimeString();
 
                calculateAndDisplayPrices();
                updateWeightValueCalculations();
            }
 
            // --- CALCULATIONS ---
            function calculateAndDisplayPrices() {
                if (lastGoldPriceUsd <= 0) return;
                const pricePerGramUsd24k = lastGoldPriceUsd / OUNCE_TO_GRAM;
                const exchangeRate = parseFloat(elements.exchangeRateInput.value) || 0;
                const sarRate = parseFloat(elements.sarExchangeRateInput.value) || 0;
 
                for (const karat in KARAT_PURITIES) {
                    const purity = KARAT_PURITIES[karat];
                    const pricePerGramKaratUsd = pricePerGramUsd24k * purity;
 
                    document.getElementById(`usd_${karat}k_price_value`).textContent = `$${pricePerGramKaratUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById(`local_${karat}k_price_value`).textContent = (pricePerGramKaratUsd * exchangeRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    document.getElementById(`sar_${karat}k_price_value`).textContent = (pricePerGramKaratUsd * sarRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            }
 
            function updateWeightValueCalculations() {
                const weight = parseFloat(elements.weightValueInput.value);
                while (elements.valueCalcGrid.children.length > 4) {
                    elements.valueCalcGrid.removeChild(elements.valueCalcGrid.lastChild);
                }
 
                if (lastGoldPriceUsd <= 0 || !weight || weight <= 0) return;
 
                const pricePerGram24kUsd = lastGoldPriceUsd / OUNCE_TO_GRAM;
                const exchangeRate = parseFloat(elements.exchangeRateInput.value) || 0;
                const sarRate = parseFloat(elements.sarExchangeRateInput.value) || 0;
 
                for (const karat in KARAT_PURITIES) {
                    const purity = KARAT_PURITIES[karat];
                    const pricePerGramKaratUsd = pricePerGram24kUsd * purity;
                    const totalUsd = weight * pricePerGramKaratUsd;
                    const totalLocal = totalUsd * exchangeRate;
                    const totalSar = totalUsd * sarRate;
 
                    const karatLabel = document.createElement('div');
                    karatLabel.className = 'calc-karat-label';
                    karatLabel.textContent = `عيار ${karat}`;
 
                    const localResult = document.createElement('div');
                    localResult.className = 'calc-grid-result';
                    localResult.textContent = totalLocal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
 
                    const usdResult = document.createElement('div');
                    usdResult.className = 'calc-grid-result';
                    usdResult.textContent = `$${totalUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
 
                    const sarResult = document.createElement('div');
                    sarResult.className = 'calc-grid-result';
                    sarResult.textContent = `${totalSar.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ر.س`;
                     
                    elements.valueCalcGrid.append(karatLabel, localResult, usdResult, sarResult);
                }
            }
             
            function updateWeightConversionCalculations() {
                const sourceWeight = parseFloat(elements.sourceWeightInput.value);
                const sourceKarat = elements.sourceKaratSelector.value;
                while (elements.conversionCalcGrid.children.length > 2) {
                    elements.conversionCalcGrid.removeChild(elements.conversionCalcGrid.lastChild);
                }
 
                if (!sourceKarat || !sourceWeight || sourceWeight <= 0) return;
 
                const sourcePurity = KARAT_PURITIES[sourceKarat];
                const pureGoldMass = sourceWeight * sourcePurity;
 
                for (const targetKarat in KARAT_PURITIES) {
                    const targetPurity = KARAT_PURITIES[targetKarat];
                    const newWeight = pureGoldMass / targetPurity;
 
                    const label = document.createElement('div');
                    label.className = 'calc-karat-label';
                    label.textContent = `الوزن بعيار ${targetKarat}:`;
                     
                    const result = document.createElement('div');
                    result.className = 'calc-grid-result';
                    result.textContent = `${newWeight.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 })} جرام`;
 
                    elements.conversionCalcGrid.append(label, result);
                }
            }
 
            // --- WEBSOCKET ---
            function connect() {
                const apiKey = elements.apiKeyInput.value;
                if (!apiKey) {
                    updateStatusMessage('error', 'مفتاح API فارغ!');
                    return;
                }
                
                disconnect(); // Ensure any existing connection is closed before opening a new one
                websocket = new WebSocket(`wss://ws.finnhub.io?token=${apiKey}`);
                updateStatusMessage('connecting', 'جاري الاتصال...');
 
                websocket.onopen = () => {
                    websocket.send(JSON.stringify({'type':'subscribe', 'symbol': 'OANDA:XAU_USD'}));
                    updateStatusMessage('connected', 'متصل');
                };
 
                websocket.onmessage = (event) => {
                    try {
                       const data = JSON.parse(event.data);
                       if (data.type === 'trade' && data.data && data.data.length > 0) {
                           updatePriceLabel(data.data[0].p);
                       }
                    } catch(e) {
                        console.error("Error parsing websocket message", e);
                    }
                };
 
                websocket.onclose = () => {
                    if (isConnected) { // Only show message if it was previously connected
                        updateStatusMessage('disconnected', 'انقطع الاتصال');
                    }
                };
 
                websocket.onerror = (error) => {
                    console.error("WebSocket Error:", error);
                    updateStatusMessage('error', 'خطأ في الاتصال');
                };
            }
 
            function disconnect() {
                if (websocket) {
                    websocket.onclose = null; // prevent onclose from firing on manual disconnect
                    websocket.close();
                    websocket = null;
                }
                updateStatusMessage('disconnected', 'غير متصل');
            }
 
            // --- SETTINGS ---
            function saveSettings() {
                localStorage.setItem('goldAppData', JSON.stringify({
                    apiKey: elements.apiKeyInput.value,
                    exchangeRate: elements.exchangeRateInput.value,
                    sarRate: elements.sarExchangeRateInput.value
                }));
            }
 
            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('goldAppData'));
                elements.apiKeyInput.value = settings?.apiKey || DEFAULTS.API_KEY;
                elements.exchangeRateInput.value = settings?.exchangeRate || DEFAULTS.EXCHANGE_RATE;
                elements.sarExchangeRateInput.value = settings?.sarRate || DEFAULTS.SAR_RATE;
            }
 
            // --- EVENT LISTENERS ---
            elements.connectionButton.addEventListener('click', () => {
                isConnected ? disconnect() : connect();
            });
 
            document.getElementById('save_button').addEventListener('click', () => {
                saveSettings();
                updateStatusMessage('connecting', 'جاري إعادة الاتصال...');
                setTimeout(connect, 250);
            });
 
            document.getElementById('reset_defaults_button').addEventListener('click', () => {
                elements.apiKeyInput.value = DEFAULTS.API_KEY;
                elements.exchangeRateInput.value = DEFAULTS.EXCHANGE_RATE;
                elements.sarExchangeRateInput.value = DEFAULTS.SAR_RATE;
                saveSettings();
                updateStatusMessage('connecting', 'جاري إعادة الاتصال...');
                setTimeout(connect, 250);
            });
 
            elements.visibilityButton.addEventListener('click', () => {
                const isPassword = elements.apiKeyInput.type === 'password';
                elements.apiKeyInput.type = isPassword ? 'text' : 'password';
                elements.visibilityButton.textContent = isPassword ? 'إخفاء' : 'إظهار';
                elements.visibilityButton.classList.toggle('visible', isPassword);
            });
 
            document.getElementById('copy_api_key').addEventListener('click', () => navigator.clipboard.writeText(elements.apiKeyInput.value));
            document.getElementById('paste_api_key').addEventListener('click', async () => elements.apiKeyInput.value = await navigator.clipboard.readText());
            document.getElementById('clear_api_key').addEventListener('click', () => elements.apiKeyInput.value = '');
 
            elements.weightValueInput.addEventListener('input', updateWeightValueCalculations);
            document.getElementById('clear_calc_button').addEventListener('click', () => {
                elements.weightValueInput.value = '';
                updateWeightValueCalculations();
            });
 
            elements.sourceWeightInput.addEventListener('input', updateWeightConversionCalculations);
            elements.sourceKaratSelector.addEventListener('change', updateWeightConversionCalculations);
            document.getElementById('clear_conv_button').addEventListener('click', () => {
                elements.sourceWeightInput.value = '';
                updateWeightConversionCalculations();
            });
             
            document.querySelectorAll('.priceLabel, #global_price_value').forEach(label => {
                label.addEventListener('dblclick', () => {
                    const text = label.textContent.replace(/[$,\sر.س]/g, '').trim();
                    if (text && !isNaN(text)) {
                        navigator.clipboard.writeText(text);
                        label.classList.add('copied');
                        setTimeout(() => label.classList.remove('copied'), 500);
                    }
                });
            });
 
            // --- INITIALIZATION ---
            function initialize() {
                Object.keys(KARAT_PURITIES).forEach(karat => {
                    const option = new Option(`عيار ${karat}`, karat);
                    elements.sourceKaratSelector.add(option);
                });
                elements.sourceKaratSelector.value = "21";
 
                loadSettings();
                updateAllStatuses();
                setInterval(updateAllStatuses, 60000); 
                 
                updateWeightConversionCalculations();
                updateWeightValueCalculations();
                 
                connect();
            }
 
            initialize();
        });
    </script>
</body>
</html>